-- Creating a staging table 
CREATE TABLE default_table_staging LIKE default_table;  
INSERT INTO 
	default_table_staging 
SELECT 
	* 
FROM default_table;

-- Deleting the extra header row
DELETE FROM default_table_staging 
WHERE
    MyUnknownColumn = 'ID';
SELECT 
    *
FROM
    default_table_staging
WHERE
    MyUnknownColumn = 'ID';
SELECT 
    *
FROM
    default_table_staging;

-- Renaming columns
ALTER TABLE default_table_staging
  Change MyUnknownColumn ID INT,
  CHANGE X1 Given_credit INT,
  CHANGE X2 Gender INT,
  CHANGE X3 Education INT,
  CHANGE X4 Marital_status INT,
  CHANGE X5 Age INT,
  CHANGE X6 Sept_delay INT,
  CHANGE X7 August_delay INT,
  CHANGE X8 July_delay INT,
  CHANGE X9 June_delay INT,
  CHANGE X10 May_delay INT,
  CHANGE X11 April_delay INT,
  CHANGE X12 Sept_bill INT,
  CHANGE X13 August_bill INT,
  CHANGE X14 July_bill INT,
  CHANGE X15 June_bill INT,
  CHANGE X16 May_bill INT,
  CHANGE X17 April_bill INT,
  CHANGE X18 Sept_payment INT,
  CHANGE X19 August_payment INT,
  CHANGE X20 July_payment INT,
  CHANGE X21 June_payment INT,
  CHANGE X22 May_payment INT,
  CHANGE X23 April_payment INT,
  CHANGE Y Oct_default INT;
  
SELECT 
    *
FROM
    default_table_staging;


-- Making the gender, education, marital_status, delays and default more readable
-- Gender
ALTER TABLE default_table_staging 
MODIFY COLUMN Gender VARCHAR(10);
UPDATE default_table_staging 
SET 
    Gender = CASE
        WHEN Gender = 1 THEN 'Male'
        WHEN Gender = 2 THEN 'Female'
        ELSE 'Unknown'
    END;
SELECT 
    *
FROM
    default_table_staging;
  
  
-- Education  
ALTER TABLE default_table_staging 
MODIFY COLUMN Education VARCHAR(20);
UPDATE default_table_staging 
SET 
    Education = CASE
        WHEN Education = 1 THEN 'Graduate'
        WHEN Education = 2 THEN 'Undergrad'
        WHEN Education = 3 THEN 'High School'
        WHEN Education = 4 THEN 'Others'
        ELSE 'Unknown'
    END;
  
-- Auditing age and education
SELECT 
    age, education, COUNT(age)
FROM
    default_table_staging
WHERE
    Education = 'Graduate' AND Age IN (22)
GROUP BY age , education;
  -- AUDIT NOTE:
  -- Found 120 entries labeled 'Graduate' at age 22.
  -- This is statistically very unlikely given the typical graduation timeline.
  -- Possible causes: misreporting, recording errors, or loose classification by banks/consumers.
  -- These entries are not removed or flagged and are included as such, as it is believed that it wont affect the overall analyis.
 
 
  -- Marital Status
ALTER TABLE default_table_staging 
MODIFY COLUMN Marital_status VARCHAR(20);
UPDATE default_table_staging 
SET 
    Marital_status = CASE
        WHEN Marital_status = 1 THEN 'Married'
        WHEN Marital_status = 2 THEN 'Single'
        WHEN Marital_status = 3 THEN 'Unknown'
        ELSE 'Unknown'
    END;
SELECT 
    *
FROM
    default_table_staging;
  
-- Delays
-- September 
ALTER TABLE default_table_staging 
MODIFY COLUMN Sept_delay VARCHAR(50);
UPDATE default_table_staging 
SET 
    Sept_delay = CASE
        WHEN Sept_delay = - 2 THEN 'Dormant'
        WHEN Sept_delay = - 1 THEN 'Balance Cleared'
        WHEN Sept_delay = 0 THEN 'Minimum Due Cleared'
        WHEN Sept_delay = 1 THEN '1 Month Delay'
        WHEN Sept_delay = 2 THEN '2 Months Delay'
        WHEN Sept_delay = 3 THEN '3 Months Delay'
        WHEN Sept_delay = 4 THEN '4 Months Delay'
        WHEN Sept_delay = 5 THEN '5 Months Delay'
        WHEN Sept_delay = 6 THEN '6 Months Delay'
        WHEN Sept_delay = 7 THEN '7 Months Delay'
        WHEN Sept_delay = 8 THEN '8 Months Delay'
        WHEN Sept_delay = 9 THEN '9 Months Delay'
        ELSE 'Unknown'
    END;
  
SELECT 
    *
FROM
    default_table_staging;
  
-- August
ALTER TABLE default_table_staging 
MODIFY COLUMN August_delay VARCHAR(50);
UPDATE default_table_staging 
SET 
    August_delay = CASE
        WHEN August_delay = - 2 THEN 'Dormant'
        WHEN August_delay = - 1 THEN 'Balance Cleared'
        WHEN August_delay = 0 THEN 'Minimum Due Cleared'
        WHEN August_delay = 1 THEN '1 Month Delay'
        WHEN August_delay = 2 THEN '2 Months Delay'
        WHEN August_delay = 3 THEN '3 Months Delay'
        WHEN August_delay = 4 THEN '4 Months Delay'
        WHEN August_delay = 5 THEN '5 Months Delay'
        WHEN August_delay = 6 THEN '6 Months Delay'
        WHEN August_delay = 7 THEN '7 Months Delay'
        WHEN August_delay = 8 THEN '8 Months Delay'
        WHEN August_delay = 9 THEN '9 Months Delay'
        ELSE 'Unknown'
    END;

-- July
ALTER TABLE default_table_staging 
MODIFY COLUMN July_delay VARCHAR(50);
UPDATE default_table_staging 
SET 
    July_delay = CASE
        WHEN July_delay = - 2 THEN 'Dormant'
        WHEN July_delay = - 1 THEN 'Balance Cleared'
        WHEN July_delay = 0 THEN 'Minimum Due Cleared'
        WHEN July_delay = 1 THEN '1 Month Delay'
        WHEN July_delay = 2 THEN '2 Months Delay'
        WHEN July_delay = 3 THEN '3 Months Delay'
        WHEN July_delay = 4 THEN '4 Months Delay'
        WHEN July_delay = 5 THEN '5 Months Delay'
        WHEN July_delay = 6 THEN '6 Months Delay'
        WHEN July_delay = 7 THEN '7 Months Delay'
        WHEN July_delay = 8 THEN '8 Months Delay'
        WHEN July_delay = 9 THEN '9 Months Delay'
        ELSE 'Unknown'
    END;

-- June
ALTER TABLE default_table_staging 
MODIFY COLUMN June_delay VARCHAR(50);
UPDATE default_table_staging 
SET 
    June_delay = CASE
        WHEN June_delay = - 2 THEN 'Dormant'
        WHEN June_delay = - 1 THEN 'Balance Cleared'
        WHEN June_delay = 0 THEN 'Minimum Due Cleared'
        WHEN June_delay = 1 THEN '1 Month Delay'
        WHEN June_delay = 2 THEN '2 Months Delay'
        WHEN June_delay = 3 THEN '3 Months Delay'
        WHEN June_delay = 4 THEN '4 Months Delay'
        WHEN June_delay = 5 THEN '5 Months Delay'
        WHEN June_delay = 6 THEN '6 Months Delay'
        WHEN June_delay = 7 THEN '7 Months Delay'
        WHEN June_delay = 8 THEN '8 Months Delay'
        WHEN June_delay = 9 THEN '9 Months Delay'
        ELSE 'Unknown'
    END;

-- May
ALTER TABLE default_table_staging 
MODIFY COLUMN May_delay VARCHAR(50);
UPDATE default_table_staging 
SET 
    May_delay = CASE
        WHEN May_delay = - 2 THEN 'Dormant'
        WHEN May_delay = - 1 THEN 'Balance Cleared'
        WHEN May_delay = 0 THEN 'Minimum Due Cleared'
        WHEN May_delay = 1 THEN '1 Month Delay'
        WHEN May_delay = 2 THEN '2 Months Delay'
        WHEN May_delay = 3 THEN '3 Months Delay'
        WHEN May_delay = 4 THEN '4 Months Delay'
        WHEN May_delay = 5 THEN '5 Months Delay'
        WHEN May_delay = 6 THEN '6 Months Delay'
        WHEN May_delay = 7 THEN '7 Months Delay'
        WHEN May_delay = 8 THEN '8 Months Delay'
        WHEN May_delay = 9 THEN '9 Months Delay'
        ELSE 'Unknown'
    END;

-- April
ALTER TABLE default_table_staging 
MODIFY COLUMN April_delay VARCHAR(50);
UPDATE default_table_staging 
SET 
    April_delay = CASE
        WHEN April_delay = - 2 THEN 'Dormant'
        WHEN April_delay = - 1 THEN 'Balance Cleared'
        WHEN April_delay = 0 THEN 'Minimum Due Cleared'
        WHEN April_delay = 1 THEN '1 Month Delay'
        WHEN April_delay = 2 THEN '2 Months Delay'
        WHEN April_delay = 3 THEN '3 Months Delay'
        WHEN April_delay = 4 THEN '4 Months Delay'
        WHEN April_delay = 5 THEN '5 Months Delay'
        WHEN April_delay = 6 THEN '6 Months Delay'
        WHEN April_delay = 7 THEN '7 Months Delay'
        WHEN April_delay = 8 THEN '8 Months Delay'
        WHEN April_delay = 9 THEN '9 Months Delay'
        ELSE 'Unknown'
    END;

SELECT 
    *
FROM
    default_table_staging;

-- October default
ALTER TABLE default_table_staging 
MODIFY COLUMN Oct_default VARCHAR(20);
UPDATE default_table_staging 
SET 
    Oct_default = CASE
        WHEN Oct_default = 0 THEN 'No'
        WHEN Oct_default = 1 THEN 'Yes'
        ELSE 'Unknown'
    END;
SELECT 
    *
FROM
    default_table_staging;
  
  
-- Data Profiling
CREATE VIEW data_profiling AS
    SELECT 
        Gender,
        Education,
        Marital_status,
        Oct_default AS Default_Flag,
        COUNT(*) AS Total_Count,
        ROUND(AVG(Age), 1) AS Avg_Age
    FROM
        default_table_staging
    GROUP BY Gender , Education , Marital_status , Oct_default;

-- Count of defaults and non-defaults
CREATE VIEW defaults_and_nodefaults AS
    SELECT 
        Oct_default AS Defaulted, COUNT(*) AS Total_Count
    FROM
        default_table_staging
    GROUP BY Oct_default;


-- Chance Of Default Based on Delay History
CREATE VIEW chance_of_default AS
    SELECT 
        Sept_delay,
        COUNT(*) AS Total_Count,
        SUM(CASE
            WHEN Oct_default = 'Yes' THEN 1
            ELSE 0
        END) AS Defaults,
        ROUND(100.0 * SUM(CASE
                    WHEN Oct_default = 'Yes' THEN 1
                    ELSE 0
                END) / COUNT(*),
                2) AS Default_Percentage
    FROM
        default_table_staging
    GROUP BY Sept_delay
    ORDER BY Default_Percentage DESC;


-- Payment Trend
CREATE VIEW payment_trend AS
    SELECT 
        ID,
        July_payment,
        August_payment,
        Sept_payment,
        CASE
            WHEN
                Sept_payment < August_payment
                    AND August_payment < July_payment
            THEN
                'Declining Trend'
            ELSE 'Stable or Improving'
        END AS Payment_Trend
    FROM
        default_table_staging;


-- Customer Journey Map
CREATE VIEW journey_map AS
    SELECT 
        ID,
        Sept_delay AS Delay,
        Oct_default AS Defaulted,
        CASE
            WHEN
                Sept_delay IN ('Balance Cleared' , 'Minimum Due Cleared')
                    AND Oct_default IN ('No' , 'Unknown')
            THEN
                'Healthy Customer Journey'
            WHEN
                Sept_delay = '1 Month Delay'
                    AND Oct_default IN ('No' , 'Unknown')
            THEN
                'Early Warning Stage'
            WHEN
                Sept_delay = 'Dormant'
                    AND Oct_default IN ('No' , 'Unknown')
            THEN
                'Early Warning Stage'
            WHEN
                Sept_delay = '1 Month Delay'
                    AND Oct_default = 'Yes'
            THEN
                'Intervention Required Stage'
            WHEN Sept_delay IN ('2 Months Delay' , '3 Months Delay') THEN 'Intervention Required Stage'
            WHEN
                Sept_delay = 'Dormant'
                    AND Oct_default = 'Yes'
            THEN
                'Intervention Required Stage'
            WHEN
                Sept_delay IN ('Balance Cleared' , 'Minimum Due Cleared')
                    AND Oct_default = 'Yes'
            THEN
                'Intervention Required Stage'
            WHEN
                Sept_delay IN ('4 Months Delay' , '5 Months Delay',
                    '6 Months Delay',
                    '7 Months Delay',
                    '8 Months Delay',
                    '9 Months Delay')
            THEN
                'Intervention Required Stage'
            ELSE 'Assessment Required'
        END AS Journey_Stage
    FROM
        default_table_staging;

-- Risk Stages
CREATE OR REPLACE VIEW risk_stage AS
    SELECT 
        ID,
        Sept_delay,
        Oct_default,
        Given_credit,
        Sept_bill,
        CASE
            WHEN
                Sept_delay IN ('Balance Cleared' , 'Minimum Due Cleared', 'Dormant')
                    AND Oct_default = 'No'
            THEN
                'Stage 1 – Performing'
            WHEN Sept_delay = '1 Month Delay' THEN 'Stage 2 – Elevated Risk'
            WHEN
                Sept_delay IN ('Balance Cleared' , 'Minimum Due Cleared', 'Dormant')
                    AND Oct_default = 'Yes'
            THEN
                'Stage 2 – Elevated Risk'
            WHEN
                Sept_delay IN ('2 Months Delay' , '3 Months Delay',
                    '4 Months Delay',
                    '5 Months Delay',
                    '6 Months Delay',
                    '7 Months Delay',
                    '8 Months Delay',
                    '9 Months Delay')
            THEN
                'Stage 3 – Non-Performing'
            ELSE 'Unclassified'
        END AS Risk_Stage
    FROM
        default_table_staging
